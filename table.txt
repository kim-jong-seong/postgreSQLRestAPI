-- ============================================
-- 기존 테이블 및 관련 객체 삭제
-- ============================================

-- 트리거 삭제
DROP TRIGGER IF EXISTS set_user_id ON users;
DROP TRIGGER IF EXISTS set_updated_at ON users;
DROP TRIGGER IF EXISTS set_house_id ON houses;
DROP TRIGGER IF EXISTS set_house_member_seq ON house_members;
DROP TRIGGER IF EXISTS set_invitation_id ON house_invitations;
DROP TRIGGER IF EXISTS set_container_id ON containers;
DROP TRIGGER IF EXISTS set_item_id ON items;
DROP TRIGGER IF EXISTS set_item_log_id ON item_logs;

-- 함수 삭제
DROP FUNCTION IF EXISTS generate_user_id();
DROP FUNCTION IF EXISTS update_updated_at();
DROP FUNCTION IF EXISTS generate_house_id();
DROP FUNCTION IF EXISTS generate_house_member_seq();
DROP FUNCTION IF EXISTS generate_invitation_id();
DROP FUNCTION IF EXISTS generate_container_id();
DROP FUNCTION IF EXISTS generate_item_id();
DROP FUNCTION IF EXISTS generate_item_log_id();

-- 시퀀스 삭제
DROP SEQUENCE IF EXISTS users_id_seq;
DROP SEQUENCE IF EXISTS houses_id_seq;
DROP SEQUENCE IF EXISTS invitations_id_seq;
DROP SEQUENCE IF EXISTS containers_id_seq;
DROP SEQUENCE IF EXISTS items_id_seq;
DROP SEQUENCE IF EXISTS item_logs_id_seq;

-- 테이블 삭제 (의존성 순서 고려)
DROP TABLE IF EXISTS item_logs CASCADE;
DROP TABLE IF EXISTS items CASCADE;
DROP TABLE IF EXISTS containers CASCADE;
DROP TABLE IF EXISTS house_invitations CASCADE;
DROP TABLE IF EXISTS house_members CASCADE;
DROP TABLE IF EXISTS houses CASCADE;
DROP TABLE IF EXISTS com_code_d CASCADE;
DROP TABLE IF EXISTS com_code_m CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- ============================================
-- 사용자
-- ============================================
CREATE TABLE users (
    id VARCHAR(10) PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE SEQUENCE users_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_user_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := LPAD(nextval('users_id_seq')::TEXT, 10, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_user_id
    BEFORE INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION generate_user_id();

CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at();

-- ============================================
-- 공통코드 마스터
-- ============================================
CREATE TABLE com_code_m (
    cd VARCHAR(20) PRIMARY KEY,
    nm VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10),
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10),
    
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE SET NULL
);

-- ============================================
-- 공통코드 상세
-- ============================================
CREATE TABLE com_code_d (
    cd VARCHAR(20) PRIMARY KEY,
    nm VARCHAR(100) NOT NULL,
    up_cd VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10),
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10),
    
    FOREIGN KEY (up_cd) REFERENCES com_code_m(cd) ON DELETE CASCADE,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE SET NULL,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE SET NULL
);

-- ============================================
-- 집
-- ============================================
CREATE TABLE houses (
    id VARCHAR(11) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT
);

CREATE SEQUENCE houses_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_house_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := 'H' || TO_CHAR(CURRENT_DATE, 'YYYY') || LPAD(nextval('houses_id_seq')::TEXT, 5, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_house_id
    BEFORE INSERT ON houses
    FOR EACH ROW
    EXECUTE FUNCTION generate_house_id();

-- ============================================
-- 집 구성원
-- ============================================
CREATE TABLE house_members (
    house_id VARCHAR(11) NOT NULL,
    user_id VARCHAR(10) NOT NULL,
    seq INT NOT NULL,
    role_cd VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    PRIMARY KEY (house_id, user_id),
    FOREIGN KEY (house_id) REFERENCES houses(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_cd) REFERENCES com_code_d(cd) ON DELETE RESTRICT,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT
);

CREATE OR REPLACE FUNCTION generate_house_member_seq()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.seq IS NULL THEN
        SELECT COALESCE(MAX(seq), 0) + 1 
        INTO NEW.seq 
        FROM house_members 
        WHERE house_id = NEW.house_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_house_member_seq
    BEFORE INSERT ON house_members
    FOR EACH ROW
    EXECUTE FUNCTION generate_house_member_seq();

-- ============================================
-- 집 멤버 초대
-- ============================================
CREATE TABLE house_invitations (
    id VARCHAR(11) PRIMARY KEY,
    house_id VARCHAR(11) NOT NULL,
    inviter_user_id VARCHAR(10) NOT NULL,
    invitee_user_id VARCHAR(10) NOT NULL,
    status_cd VARCHAR(20) NOT NULL DEFAULT 'COM1400001',
    responded_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    FOREIGN KEY (house_id) REFERENCES houses(id) ON DELETE CASCADE,
    FOREIGN KEY (inviter_user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (invitee_user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (status_cd) REFERENCES com_code_d(cd) ON DELETE RESTRICT,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT
);

CREATE SEQUENCE invitations_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_invitation_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := 'INV' || TO_CHAR(CURRENT_DATE, 'YYYY') || LPAD(nextval('invitations_id_seq')::TEXT, 4, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_invitation_id
    BEFORE INSERT ON house_invitations
    FOR EACH ROW
    EXECUTE FUNCTION generate_invitation_id();

-- 대기중인 초대만 중복 방지
CREATE UNIQUE INDEX idx_unique_pending_invitation 
ON house_invitations(house_id, invitee_user_id) 
WHERE status_cd = 'COM1400001';

-- ============================================
-- 컨테이너 (영역 + 박스 통합)
-- ============================================
CREATE TABLE containers (
    id VARCHAR(11) PRIMARY KEY,
    house_id VARCHAR(11) NOT NULL,
    up_container_id VARCHAR(11),
    type_cd VARCHAR(20) NOT NULL,
    name VARCHAR(100) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    FOREIGN KEY (house_id) REFERENCES houses(id) ON DELETE CASCADE,
    FOREIGN KEY (up_container_id) REFERENCES containers(id) ON DELETE CASCADE,
    FOREIGN KEY (type_cd) REFERENCES com_code_d(cd) ON DELETE RESTRICT,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT
);

CREATE SEQUENCE containers_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_container_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := 'C' || TO_CHAR(CURRENT_DATE, 'YYYY') || LPAD(nextval('containers_id_seq')::TEXT, 5, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_container_id
    BEFORE INSERT ON containers
    FOR EACH ROW
    EXECUTE FUNCTION generate_container_id();

-- ============================================
-- 물건
-- ============================================
CREATE TABLE items (
    id VARCHAR(11) PRIMARY KEY,
    container_id VARCHAR(11) NOT NULL,
    name VARCHAR(200) NOT NULL,
    quantity INT NOT NULL DEFAULT 1,
    remk TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    FOREIGN KEY (container_id) REFERENCES containers(id) ON DELETE CASCADE,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT,
    
    CHECK (quantity >= 0)
);

CREATE SEQUENCE items_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_item_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := 'I' || TO_CHAR(CURRENT_DATE, 'YYYY') || LPAD(nextval('items_id_seq')::TEXT, 5, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_item_id
    BEFORE INSERT ON items
    FOR EACH ROW
    EXECUTE FUNCTION generate_item_id();

-- ============================================
-- 물건 이동 기록
-- ============================================
CREATE TABLE item_logs (
    id VARCHAR(11) PRIMARY KEY,
    item_id VARCHAR(11) NOT NULL,
    act_cd VARCHAR(20) NOT NULL,
    from_container_id VARCHAR(11),
    to_container_id VARCHAR(11),
    remk TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_user VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_user VARCHAR(10) NOT NULL,
    
    FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE,
    FOREIGN KEY (act_cd) REFERENCES com_code_d(cd) ON DELETE RESTRICT,
    FOREIGN KEY (from_container_id) REFERENCES containers(id) ON DELETE SET NULL,
    FOREIGN KEY (to_container_id) REFERENCES containers(id) ON DELETE SET NULL,
    FOREIGN KEY (created_user) REFERENCES users(id) ON DELETE RESTRICT,
    FOREIGN KEY (updated_user) REFERENCES users(id) ON DELETE RESTRICT
);

CREATE SEQUENCE item_logs_id_seq START 1;

CREATE OR REPLACE FUNCTION generate_item_log_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.id IS NULL OR NEW.id = '' THEN
        NEW.id := 'L' || TO_CHAR(CURRENT_DATE, 'YYYY') || LPAD(nextval('item_logs_id_seq')::TEXT, 5, '0');
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER set_item_log_id
    BEFORE INSERT ON item_logs
    FOR EACH ROW
    EXECUTE FUNCTION generate_item_log_id();

-- ============================================
-- 인덱스 생성
-- ============================================
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_com_code_d_up_cd ON com_code_d(up_cd);
CREATE INDEX idx_house_members_house ON house_members(house_id);
CREATE INDEX idx_house_members_user ON house_members(user_id);
CREATE INDEX idx_invitations_house ON house_invitations(house_id);
CREATE INDEX idx_invitations_inviter ON house_invitations(inviter_user_id);
CREATE INDEX idx_invitations_invitee ON house_invitations(invitee_user_id);
CREATE INDEX idx_invitations_status ON house_invitations(status_cd);
CREATE INDEX idx_containers_house ON containers(house_id);
CREATE INDEX idx_containers_parent ON containers(up_container_id);
CREATE INDEX idx_containers_type ON containers(type_cd);
CREATE INDEX idx_items_container ON items(container_id);
CREATE INDEX idx_item_logs_item ON item_logs(item_id);
CREATE INDEX idx_item_logs_created ON item_logs(created_at);

-- ============================================
-- 코멘트
-- ============================================
COMMENT ON TABLE users IS '사용자';
COMMENT ON TABLE houses IS '집 정보';
COMMENT ON TABLE house_members IS '집 구성원';
COMMENT ON TABLE house_invitations IS '집 멤버 초대';
COMMENT ON TABLE containers IS '컨테이너 (영역/박스 통합)';
COMMENT ON TABLE items IS '물건';
COMMENT ON TABLE item_logs IS '물건 이동 기록';
COMMENT ON TABLE com_code_m IS '공통코드 마스터';
COMMENT ON TABLE com_code_d IS '공통코드 상세';






-- ============================================
-- 기존 공통코드 삭제
-- ============================================
DELETE FROM com_code_d;
DELETE FROM com_code_m;

-- ============================================
-- 공통코드 마스터
-- ============================================
INSERT INTO com_code_m (cd, nm, created_at, created_user, updated_at, updated_user) VALUES 
('COM110', '권한', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM120', '컨테이너 종류', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM130', '행위', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM140', '초대 상태', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001');

-- ============================================
-- 공통코드 상세 - 권한
-- ============================================
INSERT INTO com_code_d (cd, nm, up_cd, created_at, created_user, updated_at, updated_user) VALUES 
('COM1100001', '관리자', 'COM110', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1100002', '멤버', 'COM110', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001');

-- ============================================
-- 공통코드 상세 - 컨테이너 종류
-- ============================================
INSERT INTO com_code_d (cd, nm, up_cd, created_at, created_user, updated_at, updated_user) VALUES 
('COM1200001', '영역', 'COM120', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1200002', '박스', 'COM120', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001');

-- ============================================
-- 공통코드 상세 - 행위
-- ============================================
INSERT INTO com_code_d (cd, nm, up_cd, created_at, created_user, updated_at, updated_user) VALUES 
('COM1300001', '반입', 'COM130', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1300002', '반출', 'COM130', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1300003', '이동', 'COM130', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1300004', '수정', 'COM130', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1300005', '수량변경', 'COM130', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001');

-- ============================================
-- 공통코드 상세 - 초대 상태
-- ============================================
INSERT INTO com_code_d (cd, nm, up_cd, created_at, created_user, updated_at, updated_user) VALUES 
('COM1400001', '대기중', 'COM140', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1400002', '수락됨', 'COM140', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1400003', '거절됨', 'COM140', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001'),
('COM1400004', '취소됨', 'COM140', CURRENT_TIMESTAMP, '0000000001', CURRENT_TIMESTAMP, '0000000001');